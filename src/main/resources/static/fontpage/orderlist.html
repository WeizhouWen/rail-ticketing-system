<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>机票管理系统</title>
    <link rel="stylesheet" href="../css/plugins/bootstrap.min.css">
    <script src="../js/jquery.js"></script>
    <script src="../js/plugins/bootstrap.min.js"></script>
</head>
<body style="background-color: #f1f1f1">
<nav class="nav navbar-inverse">
    <div class="container-fluid">
        <!-- Header -->
        <div class="navbar-header">
            <a class="navbar-brand" href="{% url 'booksystem:index' %}">高铁购票系统</a>
        </div>
        <!-- Items -->
        <ul class="nav navbar-nav navbar-right">
            <li>
                <a href="{% url 'booksystem:result' %}">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>&nbsp; 购票
                </a>
            </li>
            <li id="welcomeText">
                <a href="#">欢迎您 <span id="user"></span> 先生/女士</a>
            </li>
            <li id="userBtn">
                <a href="{% url 'booksystem:user_info' %}">
                    <span class="glyphicon glyphicon-user" aria-hidden="true"></span>&nbsp; 个人中心
                </a>
            </li>
            <li id="logoutBtn">
                <a href="" onclick="returnIndex()">
                    <span class="glyphicon glyphicon-off" aria-hidden="true"></span>&nbsp; 退出
                </a>
            </li>
            <li id="loginBtn">
                <a href="login2.html">
                    <span class="glyphicon glyphicon-log-in" aria-hidden="true"></span>&nbsp; 登录
                </a>
            </li>
        </ul>
    </div>
</nav>

<style>
    .main {
        margin-top: 20px;
        margin-left: 50px;
        margin-right: 50px;
    }
</style>

<script>
    function refund(flight_id) {
        var choice = confirm("尊敬的顾客，您确定要退票吗");
        if (choice == true) {
            window.location = "/booksystem/refund/flight/" + flight_id;
        }
    }
</script>

<div class="main">

    <table class="table table-striped table-bordered">
        <thead>
        <tr>
            <th style="text-align: center">订单号</th>
            <th style="text-align: center">起始站</th>
            <th style="text-align: center">出发时间</th>
            <th style="text-align: center">目的站</th>
            <th style="text-align: center"> 到达时间</th>
            <th style="text-align: center"> 车次</th>
            <th style="text-align: center">价格</th>
            <th style="text-align: center">状态</th>
            <th style="text-align: center">操作</th>
        </tr>
        </thead>
        <tbody style="text-align: center" id="orderTable">

        </tbody>
    </table>
</div>
<script>

</script>
<script src="../js/plugins/bootstrap.min.js"></script>
<script src="../js/plugins/slick.min.js"></script>
<script src="../js/plugins/jquery.form.js"></script>
<script src="../js/plugins/jquery.validate.min.js"></script>
<script src="../js/custom.js"></script>
<script language="JavaScript">
    fillerIn()
    var json = [];
    var storage = window.localStorage;
    var username = storage["username"];
    // ajax传递数据
    var json = {
        "username" : username
    } // 这里的orderId是指订单id,tripsId是指新车票的id
    // ajax提交数据
    $.ajax({
        type : 'POST',
        url : base_url +'/getorder',
        data : JSON.stringify(json),
        contentType : 'application/json;charset=utf-8',
        dataType : 'json',
        success : function(data) {
            if (data.stateCode === 200) {
                // 订单信息查询成功
                console.log("11")
                console.log(data.data)
                console.log("查询订单信息成功，呈现到订单信息的页面当中");
                //暂时的解决掉数据的参数传递问题
                window.localStorage.setItem("orderItem",JSON.stringify(data.data));
                json = JSON.stringify(data.data)
                // $("#orderTable").html("");
                $("#orderTable").siblings(
                    'tr'
                ).remove()

                for (var i= 0;i<data.data.length; i++) {
                    var tr;
                    tr = '<td>' + data.data[i].trueName + '</td>' + '<td>'
                        + data.data[i].orginLocation + '</td>' + '<td>'
                        + data.data[i].startTime + '</td>' + '<td>'
                        + data.data[i].destinationLocation + '</td>'
                        + '<td>' + data.data[i].reachTime + '</td>'
                        + '<td>' + data.data[i].carNum + '</td>' + '<td>'
                        + data.data[i].ticketPrice + '</td>' + '<td>'
                        + data.data[i].status + '</td>' + '<td>'
                        + '<button class="btn btn-sm btn-success" onclick="orderDetail(' + i + ')'+'">查看</button>'
                        + '<button class="btn btn-sm btn-danger" onclick="refund()">退票</button>'
                        + '</td>';
                    $("#orderTable").append('<tr>' + tr + '</tr>');
                    console.log(tr);
                }

            } else
                // 查询失败,错误信息在data.msg里面（未填写个人信息，请完善个人信息）
                alert("错误信息：" + data.msg)

        }
    })

    function refund1() {
        console.log("实现用户退票的操作");
        //获取身份证号，车次号，出发时间，始发地
        // var idCardNum = $("#identity").val();
        // var carNum = $("#carNum").val();
        var carNum = $("#carNum").val();
        var startTime = $("#startTime").val();
        var reachTime = $("#reachTime").val();
        var json = {
            "username" : window.localStorage.getItem("username"),
            "carNum" : carNum,
            "startTime" : startTime,
            "reachTime" : reachTime
        }
        // ajax提交数据
        $.ajax({
            type:'POST',
            url: base_url +'/ticketrefund',
            data:JSON.stringify(json),
            contentType:'application/json;charset=utf-8',
            dataType:'json',
            success : function(data) {
                if (data.stateCode == "200") {
                    // 个人信息查询成功
                    console.log("退票成功，呈现到个人信息的页面当中");
                    window.location.href = 'orderForm.html';
                } else
                    // 查询失败,错误信息在data.msg里面（未填写个人信息，请完善个人信息）
                    alert("错误信息：" + data.msg)
            }
        })
    }
    function orderDetail(i) {
        // 在当前界面当中填充好详细信息然后再实现改签等的操作
        $("#trueName").val('');
        $("#phone").val('');
        $("#identity").val('');
        $("#carNum").val('');
        $("#orginLocation").val('');
        $("#destinationLocation").val('');
        $("#startTime").val('');
        $("#reachTime").val('');
        $("#ticketPrice").val('');
        var data = JSON.parse(json);
        console.log(data)
        console.log(i)
        data = data[i];
        console.log("用户点击某个订单呈现出详细信息");
        $("#trueName").val(data.trueName);
        $("#phone").val(data.phoneNum);
        $("#identity").val(data.idCardNum);
        $("#carNum").val(data.carNum);
        $("#orginLocation").val(data.orginLocation);
        $("#destinationLocation").val(data.destinationLocation);
        $("#startTime").val(data.startTime);
        $("#reachTime").val(data.reachTime);
        $("#ticketPrice").val(data.ticketPrice);
    }
</script>

</body>
</html>